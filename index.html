<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Draw the Country</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
  canvas { background: white; cursor: crosshair; border: 1px solid black; image-rendering: pixelated; }
  .tools { margin-top: 10px; }
  button { margin: 5px; padding: 5px 10px; }
</style>
</head>
<body>
<h1 id="h1""></h1>
<canvas id="drawCanvas" width="400" height="400"></canvas>
<div class="tools">
  <button id="pencilBtn">Pencil</button>
  <button id="fillBtn">Fill</button>
  <button id="clearBtn">Clear</button>
  <button id="submitBtn">Submit</button>
</div>
<!-- Preview is exactly 100x100 physical pixels -->
<div id="previews" style="display:none; margin-top:10px;">
  <div style="display:inline-block; text-align:center; margin-right:20px;">
    <div>Your Drawing</div>
    <canvas id="drawingPreview" width="100" height="100" 
      style="border:1px solid black; image-rendering:pixelated;"></canvas>
  </div>
  <div style="display:inline-block; text-align:center;">
    <div>Target Country</div>
    <canvas id="countryPreview" width="100" height="100" 
      style="border:1px solid black; image-rendering:pixelated;"></canvas>
  </div>
</div>

<script>
let targetCountry;
  
fetch('country_vectors.json')
  .then(response => response.json())
  .then(data => {
    const randomCountry = data[Math.floor(Math.random() * data.length)];
    document.querySelector("h1").textContent =
      `Draw the Shape of ${randomCountry.name}`;
    targetCountry = randomCountry;
  })

const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
ctx.fillStyle = "white";
ctx.fillRect(0, 0, canvas.width, canvas.height);
ctx.imageSmoothingEnabled = false;

let tool = '';
let drawing = false;

const pencilBtn = document.getElementById('pencilBtn');
const fillBtn = document.getElementById('fillBtn');

selectTool(pencilBtn, 'pencil');

pencilBtn.onclick = () => selectTool(pencilBtn, 'pencil');
fillBtn.onclick = () => selectTool(fillBtn, 'fill');
document.getElementById('clearBtn').onclick = () => {
  ctx.fillStyle = "white";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
};
document.getElementById('submitBtn').onclick = submitDrawing;

canvas.addEventListener('mousedown', e => {
  if (tool === 'pencil') {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  } else if (tool === 'fill') {
    fillArea(e.offsetX, e.offsetY);
  }
});
canvas.addEventListener('mouseup', () => {
  drawing = false;
  binarizeCanvas();
});
canvas.addEventListener('mousemove', e => {
  if (drawing && tool === 'pencil') {
    ctx.strokeStyle = "black";
    ctx.lineWidth = 2;
    ctx.lineCap = 'butt';
    ctx.lineJoin = 'miter';
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }
});

function selectTool(selectedButton, toolName) {
  tool = toolName;
  [pencilBtn, fillBtn].forEach(btn => btn.disabled = false);
  selectedButton.disabled = true;
}
function binarizeCanvas() {
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imgData.data;
  for (let i = 0; i < data.length; i += 4) {
    const v = data[i] < 128 ? 0 : 255;
    data[i] = data[i+1] = data[i+2] = v;
    data[i+3] = 255;
  }
  ctx.putImageData(imgData, 0, 0);
}
function fillArea(x, y) {
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imgData.data;
  const targetColor = getPixelColor(data, x, y);
  const replacement = targetColor[0] === 0 ? [255,255,255,255] : [0,0,0,255];
  floodFill(data, x, y, targetColor, replacement, imgData.width, imgData.height);
  ctx.putImageData(imgData, 0, 0);
}
function getPixelColor(data, x, y) {
  const i = (y * canvas.width + x) * 4;
  return [data[i], data[i+1], data[i+2], data[i+3]];
}
function colorsMatch(a, b) {
  return a[0]===b[0] && a[1]===b[1] && a[2]===b[2] && a[3]===b[3];
}
function floodFill(data, x, y, target, replacement, w, h) {
  if (colorsMatch(target, replacement)) return;
  const stack = [[x,y]];
  while (stack.length) {
    const [cx, cy] = stack.pop();
    if (cx<0 || cy<0 || cx>=w || cy>=h) continue;
    const idx = (cy*w+cx)*4;
    const current = [data[idx], data[idx+1], data[idx+2], data[idx+3]];
    if (!colorsMatch(current, target)) continue;
    data[idx]=replacement[0];
    data[idx+1]=replacement[1];
    data[idx+2]=replacement[2];
    data[idx+3]=replacement[3];
    stack.push([cx+1, cy],[cx-1, cy],[cx, cy+1],[cx, cy-1]);
  }
}
function jaccards(vector1, vector2) {
    let intersection = 0;
    let union = 0;
  
    for (let i = 0; i < vector1.length; i++) {
      if (vector1[i] === 1 && vector2[i] === 1) {
        intersection++;
      }
      if (vector1[i] === 1 || vector2[i] === 1) {
        union++;
      }
    }
  
    return union === 0 ? 0 : intersection / union;
}
function submitDrawing() {
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = 100;
  tempCanvas.height = 100;
  const tctx = tempCanvas.getContext('2d');
  tctx.fillStyle = "white";
  tctx.fillRect(0, 0, 100, 100);

  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imgData.data;
  let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
  for (let y=0; y<canvas.height; y++) {
    for (let x=0; x<canvas.width; x++) {
      const idx = (y*canvas.width + x) * 4;
      if (data[idx] < 255) {
        if (x < minX) minX = x;
        if (y < minY) minY = y;
        if (x > maxX) maxX = x;
        if (y > maxY) maxY = y;
      }
    }
  }

  if (maxX <= minX || maxY <= minY) {
    alert("No drawing found!");
    return;
  }

  const shapeW = maxX - minX;
  const shapeH = maxY - minY;
  const aspect = shapeW / shapeH;
  let drawW, drawH;
  if (aspect > 1) {
    drawW = 100;
    drawH = Math.round(100 / aspect);
  } else {
    drawH = 100;
    drawW = Math.round(100 * aspect);
  }

  tctx.drawImage(canvas, minX, minY, shapeW, shapeH, 0, 0, drawW, drawH);

  const finalData = tctx.getImageData(0, 0, 100, 100).data;
  let arr = [];
  for (let i = 0; i < finalData.length; i += 4) {
    arr.push(finalData[i] < 128 ? 1 : 0);
  }

  document.getElementById('previews').style.display = 'block';

  // Draw preview pixel by pixel from arr
  const preview1 = document.getElementById('drawingPreview').getContext('2d');
  const preview2 = document.getElementById('countryPreview').getContext('2d');
  preview1.clearRect(0, 0, 100, 100);
  preview2.clearRect(0, 0, 100, 100);
  for (let i = 0; i < arr.length; i++) {
    const x = i % 100;
    const y = Math.floor(i / 100);
    preview1.fillStyle = arr[i] === 1 ? 'black' : 'white';
    preview1.fillRect(x, y, 1, 1);
    preview2.fillStyle = targetCountry.vector[i] === 1 ? 'black' : 'white';
    preview2.fillRect(x, y, 1, 1);
  }

  const similarity = jaccards(arr, targetCountry.vector);
  alert(`Similarity to ${targetCountry.name}: ${(similarity * 100).toFixed(2)}%`);
}
</script>
</body>
</html>

